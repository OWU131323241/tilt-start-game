<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>傾け合わせゲーム（常時START表示）</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>
  <style>
    body { margin: 0; background: #111; color: #fff; font-family: sans-serif; }
    #ui {
      position: absolute;
      left: 15px;
      top: 15px;
      z-index: 10;
      background: rgba(0,0,0,0.5);
      padding: 8px 12px;
      border-radius: 8px;
    }
    button { margin-top: 6px; padding: 5px 10px; }
  </style>
</head>
<body>
  <div id="ui">
    <div>あなたのID: <span id="myid"></span></div>
    <button id="connect">ルームに入る</button>
  </div>

<script>
let socket = io.connect();
let btn = document.querySelector("#connect");
let g = 0, b = 0;

let myid = sessionStorage.getItem('clientId');
if (!myid) {
  myid = Math.random().toString(36).substring(2, 15);
  sessionStorage.setItem('clientId', myid);
}
document.querySelector("#myid").innerText = myid;

btn.addEventListener("click", () => {
  socket.emit("join", "game");
  btn.disabled = true;
  btn.innerText = "接続中...";
});

socket.on("sensor", data => {
  g = parseFloat(data.g) || 0;
  b = parseFloat(data.b) || 0;
});

let state = "start"; // ←最初から"start"
let shapes = ["square", "star", "heart", "uShape", "hex"];
let stageIndex = 0;
let targetAngle = 0;
let threshold = 6;
let startTime = 0;
let finalTime = 0;

function setup(){
  createCanvas(800, 800);
  textFont('sans-serif');
  textAlign(CENTER, CENTER);
  textSize(28);
  resetTarget();
}

function playerAngle(){ return (g + b) / 2; }
function resetTarget(){ targetAngle = random(-45, 45); }

function draw(){
  background(18);
  drawHUD();

  push();
  translate(width/2, height/2);

  // --- 点線ガイド ---
  push();
  rotate(radians(targetAngle));
  drawingContext.setLineDash([10,10]);
  stroke(200, 200, 255, 180);
  strokeWeight(3);
  noFill();
  drawShape(currentShape(), 200, true);
  drawingContext.setLineDash([]);
  pop();

  // --- プレイヤー図形 ---
  push();
  rotate(radians(playerAngle()));
  noStroke();
  fill(255, 170, 60);
  drawShape(currentShape(), 200, false);
  pop();

  pop();

  checkStateTransitions();

  // --- ALL CLEAR 表示 ---
  if(state === "clear"){
    push();
    fill(20, 220, 120, 230);
    rectMode(CENTER);
    noStroke();
    rect(width/2, height/2, 520, 240, 12);
    fill(10);
    textSize(44);
    textAlign(CENTER, CENTER);
    text("ALL CLEAR!", width/2, height/2 - 30);
    textSize(28);
    text(`TOTAL TIME: ${nf(finalTime,1,2)} s`, width/2, height/2 + 30);
    pop();
  }
}

function currentShape(){
  if(state === "start") return "START";
  if(state === "restart") return "RESTART";
  return shapes[stageIndex];
}

function drawShape(name, size, guide){
  if(name === "square"){
    rectMode(CENTER);
    rect(0, 0, size, size, 6);
  } 
  else if(name === "star"){
    drawStar(0, 0, size/2.8, size/1.2, 5);
  }
  else if(name === "heart"){
    drawHeart(0, 0, size);
  }
  else if(name === "uShape"){
    drawU(0, 0, size);
  }
  else if(name === "hex"){
    drawHex(0, 0, size/2);
  }
  else if(name === "START" || name === "RESTART"){
    fill(guide ? "rgba(200,200,255,0.8)" : "#fff");
    noStroke();
    textSize(72);
    text(name, 0, 0);
  }
}

function drawStar(x, y, r1, r2, npoints) {
  let angle = TWO_PI / npoints, half = angle/2;
  beginShape();
  for (let a = 0; a < TWO_PI; a += angle) {
    vertex(x + cos(a) * r2, y + sin(a) * r2);
    vertex(x + cos(a + half) * r1, y + sin(a + half) * r1);
  }
  endShape(CLOSE);
}

function drawHeart(x, y, s) {
  beginShape();
  vertex(x, y + s/4);
  bezierVertex(x - s/2, y - s/3, x - s, y + s/4, x, y + s);
  bezierVertex(x + s, y + s/4, x + s/2, y - s/3, x, y + s/4);
  endShape(CLOSE);
}

function drawU(x, y, s) {
  let w = s * 0.6, h = s * 0.9;
  beginShape();
  vertex(x - w/2, y - h/2);
  vertex(x - w/2, y + h/2);
  bezierVertex(x - w/2, y + h/1.5, x + w/2, y + h/1.5, x + w/2, y + h/2);
  vertex(x + w/2, y - h/2);
  endShape(CLOSE);
}

function drawHex(x, y, r) {
  beginShape();
  for (let a = 0; a < TWO_PI; a += TWO_PI / 6) vertex(x + cos(a) * r, y + sin(a) * r);
  endShape(CLOSE);
}

function drawHUD(){
  fill(255);
  noStroke();
  textSize(18);
  textAlign(LEFT, TOP);
  text(`target: ${nf(targetAngle,1,1)}°`, 12, 100);
  text(`player: ${nf(playerAngle(),1,1)}°`, 12, 120);
  text(`threshold: ±${threshold}°`, 12, 140);

  textAlign(CENTER, TOP);
  if(state === "start") text("START を点線に合わせてください", width/2, 12);
  else if(state === "restart") text("RESTART で再スタート", width/2, 12);
  else if(state === "play") text(`ステージ ${stageIndex+1} / ${shapes.length}`, width/2, 12);
}

function checkStateTransitions(){
  const diff = abs(playerAngle() - targetAngle);
  if(state === "start" && diff <= threshold){
    state = "transition";
    setTimeout(()=>{ state="play"; stageIndex=0; startTime=millis(); resetTarget(); },600);
  }
  if(state === "play" && diff <= threshold){
    stageIndex++;
    if(stageIndex >= shapes.length){
      finalTime = (millis() - startTime) / 1000.0;
      state = "clear";
      setTimeout(()=>{ state="restart"; resetTarget(); },1200);
    } else {
      state = "transition";
      setTimeout(()=>{ state="play"; resetTarget(); },600);
    }
  }
  if(state === "restart" && diff <= threshold){
    state = "transition";
    setTimeout(()=>{ state="start"; resetTarget(); },600);
  }
}
</script>
</body>
</html>
